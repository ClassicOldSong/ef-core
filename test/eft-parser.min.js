!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):e.parseEft=r()}(this,function(){"use strict";var e=new RegExp("\\&[0-7]{1,3}","g"),r=new RegExp("\\&u\\[.*?\\]","g"),t=new RegExp("\\&u.{0,4}","g"),n=new RegExp("\\&x.{0,2}","g"),a=new RegExp("\\&","g"),o=new RegExp("\\&b","g"),i=new RegExp("\\&t","g"),p=new RegExp("\\&n","g"),s=new RegExp("\\&v","g"),c=new RegExp("\\&f","g"),u=new RegExp("\\&r","g"),f=function(){throw new SyntaxError("Octal escape sequences are not allowed in EFML.")},l=function(e){if(e=e.substr(3,e.length-4),!(e=parseInt(e,16)))throw new SyntaxError("Invalid Unicode escape sequence");try{return String.fromCodePoint(e)}catch(e){throw new SyntaxError("Undefined Unicode code-point")}},d=function(e){if(e=e.substring(2),!(e=parseInt(e,16)))throw new SyntaxError("Invalid Unicode escape sequence");return String.fromCharCode(e)},g=function(e){if(e="00"+e.substring(2),!(e=parseInt(e,16)))throw new SyntaxError("Invalid hexadecimal escape sequence");return String.fromCharCode(e)},h=function(h){for(var v=[],m=0,w=h.split("&&");m<w.length;m+=1){var x=w[m].replace(e,f).replace(r,l).replace(t,d).replace(n,g).replace(o,"\b").replace(i,"\t").replace(p,"\n").replace(s,"\v").replace(c,"\f").replace(u,"\r").replace(a,"");v.push(x)}return v.join("&")},v=">#%@.-+".split(""),m="__EFPLACEHOLDER__ $parent $key $data $element $refs $methods $mount $umount $subscribe $unsubscribe $update $destroy __DIRECTMOUNT__".split(" "),w=/\{\{.+?\}\}/g,x=/^(\t*)( *).*/,E=/#([^}]|}[^}])*$/,y=function(e,r){return void 0===r&&(r=-2),"Failed to parse eft template: "+e+". at line "+(r+1)},b=function(e){return!e.replace(/\s/,"")},R=function(e){return["number","boolean","string"].indexOf(typeof e)>-1},N=function(e){if(!e)return[e,!1];try{var r=JSON.parse(e);return-1===["number","boolean"].indexOf(typeof r)?[h(e),!0]:[r,!1]}catch(r){return[h(e),!0]}},k=function(e,r){null===r.offset&&(r.offset=e.match(/\s*/)[0],r.offset&&(r.offsetReg=new RegExp("^"+r.offset)))},T=function(e,r,t){if(r.offsetReg){var n=!1;if(e=e.replace(r.offsetReg,function(){return n=!0,""}),!n)throw new SyntaxError(y("Expected indent to be grater than 0 and less than "+(r.prevDepth+1)+", but got -1",t))}return e},S=function(e,r){if(!r.indentReg){var t=e.match(x)[2];t&&(r.indentReg=new RegExp(t,"g"))}},$=function(e,r,t){var n=0;r.indentReg&&(e=e.replace(/^\s*/,function(e){return e.replace(r.indentReg,"\t")}));var a=e.replace(/^\t*/,function(e){return n=e.length,""});if(/^\s/.test(a))throw new SyntaxError(y("Bad indent",t));return{depth:n,content:a}},D=function(e,r){for(var t=e,n=0;n<r;n++)t=t[t.length-1];return t},I=function(e){var r=(e=e.slice(2,e.length-2)).split("="),t=r[0],n=r.slice(1),a=t.trim().split("."),o=N(n.join("=").trim()),i=o[0],p=o[1];return R(i)&&(p||!p&&""!==i)?[a,i]:[a]},O=function(e){var r=e.split(w);if(1===r.length)return N(e)[0];var t=[];2!==r.length||r[0]||r[1]?t.push(r.map(h)):t.push(0);var n=e.match(w);return n&&t.push.apply(t,n.map(I)),t},_=function(e,r){r&&e.push(r)},j=function(e){var r=O(e);if(R(r))return[""+r];for(var t=r[0],n=r.slice(1),a=[],o=0;o<n.length;o++)_(a,t[o]),a.push(n[o]);return _(a,t[t.length-1]),a},C=function(e){return e.replace(/\./g," ")},q=function(e){var r={},t=e.replace(E,function(e){return r.ref=e.slice(1),""}).split("."),n=t[0],a=t.slice(1);return r.tag=n,r.class=O(a.join(".")),"string"==typeof r.class?r.class=C(r.class).trim():r.class[0]&&(r.class[0]=r.class[0].map(C)),r},U=function(e){var r=e.split("=");return{name:r.shift().trim(),value:O(r.join("=").trim())}},F=function(e){var r=e.split("=");return{name:r.shift().trim(),value:r.join("=").trim()}},L=function(e,r){switch(r){case"stop":e.s=1;break;case"stopImmediate":e.i=1;break;case"prevent":e.p=1;break;case"shift":e.h=1;break;case"alt":e.a=1;break;case"ctrl":e.c=1;break;case"meta":e.t=1;break;case"capture":e.u=1;break;default:console.warn("Abandoned unsupported event option '"+r+"'.")}},A=function(e,r,t){var n=parseInt(t,10);if(isNaN(n))return L(e,t);r.push(n)},M=function(e){var r={},t=[],n=e.split("."),a=n[0],o=n.slice(1);r.l=a;for(var i=0,p=o;i<p.length;i+=1){var s=p[i];A(r,t,s)}return t.length>0&&(r.k=t),r},P=function(e){var r=e.split(":"),t=r[0],n=r.slice(1).join(":");return n?[t.trim(),O(n)]:[t.trim()]},B=function(e){var r=e.line,t=e.ast,n=e.parsingInfo,a=e.i;if(!b(r)){S(r,n),k(r,n);var o=$(T(r,n,a),n,a),i=o.depth,p=o.content;if(p){if(i<0||i-n.prevDepth>1||i-n.prevDepth==1&&-1===["comment","tag"].indexOf(n.prevType)||"comment"!==n.prevType&&0===i&&n.topExists)throw new SyntaxError(y("Expected indent to be grater than 0 and less than "+(n.prevDepth+1)+", but got "+i,a));var s=p[0];if(p=p.slice(1),!n.topExists&&v.indexOf(s)>=0&&">"!==s)throw new SyntaxError(y("No top level entry",a));if(!p&&v.indexOf(s)>=0)throw new SyntaxError(y("Empty content",a));switch((i<n.prevDepth||i===n.prevDepth&&"tag"===n.prevType)&&(n.currentNode=D(t,i)),n.prevDepth=i,s){case">":n.topExists||(n.topExists=!0,n.minDepth=i);var c=q(p),u=[{t:c.tag}];c.class&&(u[0].a={},u[0].a.class=c.class),c.ref&&(u[0].r=c.ref),n.currentNode.push(u),n.currentNode=u,n.prevType="tag";break;case"#":var f=U(p),l=f.name,d=f.value;n.currentNode[0].a||(n.currentNode[0].a={}),n.currentNode[0].a[l]=d,n.prevType="attr";break;case"%":var g=U(p),h=g.name,w=g.value;n.currentNode[0].p||(n.currentNode[0].p={}),n.currentNode[0].p[h]=w,n.prevType="prop";break;case"@":var x=F(p),E=x.name,R=x.value;n.currentNode[0].e||(n.currentNode[0].e=[]);var N=M(E),I=P(R),O=I[0],_=I[1];N.m=O,_&&(N.v=_),n.currentNode[0].e.push(N),n.prevType="event";break;case".":(C=n.currentNode).push.apply(C,j(p)),n.prevType="text";break;case"-":if(-1!==m.indexOf(p))throw new SyntaxError(y("Reserved name '"+p+"' should not be used",a));n.currentNode.push({n:p,t:0}),n.prevType="node";break;case"+":n.currentNode.push({n:p,t:1}),n.prevType="list";break;default:n.prevType="comment"}}var C}};return function(e){if(!e)throw new TypeError(y("Template required, but nothing given"));var r=typeof e;if("string"!==r)throw new TypeError(y("Expected a string, but got a(n) "+r));for(var t=e.split(/\r?\n/),n=[],a={indentReg:null,prevDepth:0,offset:null,offsetReg:null,prevType:"comment",currentNode:n,topExists:!1},o=0;o<t.length;o++)B({line:t[o],ast:n,parsingInfo:a,i:o});if(n[0])return n[0];throw new SyntaxError(y("Nothing to be parsed",t.length-1))}});
