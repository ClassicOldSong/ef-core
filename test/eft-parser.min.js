!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.parseEft=t()}(this,function(){"use strict";var e=function(e,t){return t={exports:{}},e(t,t.exports),t.exports}(function(e){var t=new RegExp("\\&[0-7]{1,3}","g"),r=new RegExp("\\&u\\[.*?\\]","g"),n=new RegExp("\\&u.{0,4}","g"),a=new RegExp("\\&x.{0,2}","g"),o=new RegExp("\\&","g"),p=new RegExp("\\&b","g"),i=new RegExp("\\&t","g"),s=new RegExp("\\&n","g"),c=new RegExp("\\&v","g"),u=new RegExp("\\&f","g"),f=new RegExp("\\&r","g"),l=function(){throw new SyntaxError("Octal escape sequences are not allowed in EFML.")},d=function(e){if(e=e.substr(3,e.length-4),!(e=parseInt(e,16)))throw new SyntaxError("Invalid Unicode escape sequence");try{return String.fromCodePoint(e)}catch(e){throw new SyntaxError("Undefined Unicode code-point")}},g=function(e){if(e=e.substring(2),!(e=parseInt(e,16)))throw new SyntaxError("Invalid Unicode escape sequence");return String.fromCharCode(e)},h=function(e){if(e="00"+e.substring(2),!(e=parseInt(e,16)))throw new SyntaxError("Invalid hexadecimal escape sequence");return String.fromCharCode(e)};e.exports=function(e){for(var v=[],m=0,x=e.split("&&");m<x.length;m+=1){var w=x[m].replace(t,l).replace(r,d).replace(n,g).replace(a,h).replace(p,"\b").replace(i,"\t").replace(s,"\n").replace(c,"\v").replace(u,"\f").replace(f,"\r").replace(o,"");v.push(w)}return v.join("&")}}),t=">#%@.-+".split(""),r="__EFPLACEHOLDER__ $parent $key $data $element $refs $methods $mount $umount $subscribe $unsubscribe $update $destroy __DIRECTMOUNT__".split(" "),n=/\{\{.+?\}\}/g,a=/^(\t*)( *).*/,o=/#([^}]|}[^}])*$/,p=function(e,t){return void 0===t&&(t=-2),"Failed to parse eft template: "+e+". at line "+(t+1)},i=function(e){return!e.replace(/\s/,"")},s=function(e,t){null===t.offset&&(t.offset=e.match(/\s*/)[0],t.offset&&(t.offsetReg=new RegExp("^"+t.offset)))},c=function(e,t,r){if(t.offsetReg){var n=!1;if(e=e.replace(t.offsetReg,function(){return n=!0,""}),!n)throw new SyntaxError(p("Expected indent to be grater than 0 and less than "+(t.prevDepth+1)+", but got -1",r))}return e},u=function(e,t){if(!t.indentReg){var r=e.match(a)[2];r&&(t.indentReg=new RegExp(r,"g"))}},f=function(e,t,r){var n=0;t.indentReg&&(e=e.replace(/^\s*/,function(e){return e.replace(t.indentReg,"\t")}));var a=e.replace(/^\t*/,function(e){return n=e.length,""});if(/^\s/.test(a))throw new SyntaxError(p("Bad indent",r));return{depth:n,content:a}},l=function(e,t){for(var r=e,n=0;n<t;n++)r=r[r.length-1];return r},d=function(t){var r=(t=t.slice(2,t.length-2)).split("="),n=r[0],a=r.slice(1),o=n.trim().split("."),p=e(a.join("=").trim());return p?[o,p]:[o]},g=function(t){var r=t.split(n);if(1===r.length)return e(t);var a=[];2!==r.length||r[0]||r[1]?a.push(r.map(e)):a.push(0);var o=t.match(n);return o&&a.push.apply(a,o.map(d)),a},h=function(e,t){t&&e.push(t)},v=function(e){var t=g(e);if("string"==typeof t)return[t];for(var r=t[0],n=t.slice(1),a=[],o=0;o<n.length;o++)h(a,r[o]),a.push(n[o]);return h(a,r[r.length-1]),a},m=function(e){return e.replace(/\./g," ")},x=function(e){var t={},r=e.replace(o,function(e){return t.ref=e.slice(1),""}).split("."),n=r[0],a=r.slice(1);return t.tag=n,t.class=g(a.join(".")),"string"==typeof t.class?t.class=m(t.class).trim():t.class[0]&&(t.class[0]=t.class[0].map(m)),t},w=function(e){var t=e.split("=");return{name:t.shift().trim(),value:g(t.join("=").trim())}},E=function(e){var t=e.split("=");return{name:t.shift().trim(),value:t.join("=").trim()}},y=function(e,t){switch(t){case"stop":e.s=1;break;case"stopImmediate":e.i=1;break;case"prevent":e.p=1;break;case"shift":e.h=1;break;case"alt":e.a=1;break;case"ctrl":e.c=1;break;case"meta":e.t=1;break;case"capture":e.u=1;break;default:console.warn("Abandoned unsupported event option '"+t+"'.")}},b=function(e,t,r){var n=parseInt(r,10);if(isNaN(n))return y(e,r);t.push(n)},R=function(e){var t={},r=[],n=e.split("."),a=n[0],o=n.slice(1);t.l=a;for(var p=0,i=o;p<i.length;p+=1){var s=i[p];b(t,r,s)}return r.length>0&&(t.k=r),t},N=function(e){var t=e.split(":"),r=t[0],n=t.slice(1).join(":");return n?[r.trim(),g(n)]:[r.trim()]},k=function(e){var n=e.line,a=e.ast,o=e.parsingInfo,d=e.i;if(!i(n)){u(n,o),s(n,o);var g=f(c(n,o,d),o,d),h=g.depth,m=g.content;if(m){if(h<0||h-o.prevDepth>1||h-o.prevDepth==1&&-1===["comment","tag"].indexOf(o.prevType)||"comment"!==o.prevType&&0===h&&o.topExists)throw new SyntaxError(p("Expected indent to be grater than 0 and less than "+(o.prevDepth+1)+", but got "+h,d));var y=m[0];if(m=m.slice(1),!o.topExists&&t.indexOf(y)>=0&&">"!==y)throw new SyntaxError(p("No top level entry",d));if(!m&&t.indexOf(y)>=0)throw new SyntaxError(p("Empty content",d));switch((h<o.prevDepth||h===o.prevDepth&&"tag"===o.prevType)&&(o.currentNode=l(a,h)),o.prevDepth=h,y){case">":o.topExists||(o.topExists=!0,o.minDepth=h);var b=x(m),k=[{t:b.tag}];b.class&&(k[0].a={},k[0].a.class=b.class),b.ref&&(k[0].r=b.ref),o.currentNode.push(k),o.currentNode=k,o.prevType="tag";break;case"#":var T=w(m),S=T.name,$=T.value;o.currentNode[0].a||(o.currentNode[0].a={}),o.currentNode[0].a[S]=$,o.prevType="attr";break;case"%":var D=w(m),I=D.name,_=D.value;o.currentNode[0].p||(o.currentNode[0].p={}),o.currentNode[0].p[I]=_,o.prevType="prop";break;case"@":var j=E(m),C=j.name,O=j.value;o.currentNode[0].e||(o.currentNode[0].e=[]);var q=R(C),U=N(O),F=U[0],L=U[1];q.m=F,L&&(q.v=L),o.currentNode[0].e.push(q),o.prevType="event";break;case".":(A=o.currentNode).push.apply(A,v(m)),o.prevType="text";break;case"-":if(-1!==r.indexOf(m))throw new SyntaxError(p("Reserved name '"+m+"' should not be used",d));o.currentNode.push({n:m,t:0}),o.prevType="node";break;case"+":o.currentNode.push({n:m,t:1}),o.prevType="list";break;default:o.prevType="comment"}}var A}};return function(e){if(!e)throw new TypeError(p("Template required, but nothing present"));var t=typeof e;if("string"!==t)throw new TypeError(p("Expected a string, but got a(n) "+t));for(var r=e.split(/\r?\n/),n=[],a={indentReg:null,prevDepth:0,offset:null,offsetReg:null,prevType:"comment",currentNode:n,topExists:!1},o=0;o<r.length;o++)k({line:r[o],ast:n,parsingInfo:a,i:o});if(n[0])return n[0];throw new SyntaxError(p("Nothing to be parsed",r.length-1))}});
