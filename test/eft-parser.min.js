!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):(e="undefined"!=typeof globalThis?globalThis:e||self).parseEft=r()}(this,(function(){"use strict";var e="&",r="&&",t=new RegExp("\\&[0-7]{1,3}","g"),n=new RegExp("\\&u\\[.*?\\]","g"),a=new RegExp("\\&u.{0,4}","g"),o=new RegExp("\\&x.{0,2}","g"),p=new RegExp("\\&","g"),i=new RegExp("\\&b","g"),s=new RegExp("\\&t","g"),c=new RegExp("\\&n","g"),u=new RegExp("\\&v","g"),f=new RegExp("\\&f","g"),l=new RegExp("\\&r","g"),h=function(){throw new SyntaxError("Octal escape sequences are not allowed in EFML.")},g=function(e){if(e=e.substr(3,e.length-4),!(e=parseInt(e,16)))throw new SyntaxError("Invalid Unicode escape sequence");try{return String.fromCodePoint(e)}catch(e){throw new SyntaxError("Undefined Unicode code-point")}},d=function(e){if(e=e.substring(2),!(e=parseInt(e,16)))throw new SyntaxError("Invalid Unicode escape sequence");return String.fromCharCode(e)},v=function(e){if(e="00"+e.substring(2),!(e=parseInt(e,16)))throw new SyntaxError("Invalid hexadecimal escape sequence");return String.fromCharCode(e)},m=function(m){for(var y=[],b=0,w=m.split(r);b<w.length;b+=1){var x=w[b].replace(t,h).replace(n,g).replace(a,d).replace(o,v).replace(i,"\b").replace(s,"\t").replace(c,"\n").replace(u,"\v").replace(f,"\f").replace(l,"\r").replace(p,"");y.push(x)}return y.join(e)},y=function(r){return r[r.length-1]===e},b=function(e,r){for(var t=[],n=!1,a=0,o=e.split(r);a<o.length;a+=1){var p=o[a];n?t[t.length-1]+=""+r+p:t.push(p),n=y(p)}return t},w=function(e,t){for(var n=e.split(r),a=b(n.shift(),t),o=0,p=n;o<p.length;o+=1){var i=p[o],s=b(i,t);a[a.length-1]+="&&"+s.shift(),a.push.apply(a,s)}return a},x=["$ctx","$refs","$data","$methods","$mount","$umount","$subscribe","$unsubscribe","$update","$dispatch","$emit","$on","$off","$destroy","__DIRECTMOUNT__"],E=/\{\{.+?\}\}/g,N=/^(\t*)( *).*/,R=/#([^}]|}[^}])*$/,T=function(e,r){return void 0===r&&(r=-2),"Failed to parse eft template: "+e+". at line "+(r+1)},k=function(e){return["number","boolean","string"].indexOf(typeof e)>-1},S=function(e){if(!e)return[e,!1];try{var r=JSON.parse(e);return-1===["number","boolean"].indexOf(typeof r)?[m(e),!0]:[r,!1]}catch(r){return[m(e),!0]}},$=function(e){e=e.slice(2,e.length-2);var r=w(e,"="),t=r[0],n=r.slice(1),a=w(t.trim(),".").map(m),o=S(n.join("=").trim()),p=o[0],i=o[1];return k(p)&&(i||!i&&""!==p)?[a,p]:[a]},O=function(e){var r=e.split(E);if(1===r.length)return S(e)[0];var t=[];2!==r.length||r[0]||r[1]?t.push(r.map(m)):t.push(0);var n=e.match(E);return n&&t.push.apply(t,n.map($)),t},I=function(e,r){r&&e.push(r)},j=function(e){var r=O(e);if(k(r))return[""+r];for(var t=r[0],n=r.slice(1),a=[],o=0;o<n.length;o++)I(a,t[o]),a.push(n[o]);return I(a,t[t.length-1]),a},D=function(e){return e.replace(/\./g," ")},C=function(e,r,t){var n=parseInt(t,10);if(isNaN(n))return function(e,r){switch(r){case"stop":e.s=1;break;case"stopImmediate":e.i=1;break;case"prevent":e.p=1;break;case"shift":e.h=1;break;case"alt":e.a=1;break;case"ctrl":e.c=1;break;case"meta":e.t=1;break;case"capture":e.u=1;break;case"passive":e.e=1,delete e.p;break;case"!passive":e.e=0;break;case"once":e.o=1;break;default:console.warn("Unsupported event option '"+r+"' will be dropped.")}}(e,m(t));r.push(n)},U=function(e){var r={},t=[],n=w(e,"."),a=n[0],o=n.slice(1);r.l=m(a);for(var p=0,i=o;p<i.length;p+=1){var s=i[p];C(r,t,s)}return t.length>0&&(r.k=t),r},q=function(e){var r,t,n=e.line,a=e.ast,o=e.parsingInfo,p=e.i;if(n.replace(/\s/,"")){!function(e,r){null===r.offset&&(r.offset=e.match(/\s*/)[0],r.offset&&(r.offsetReg=r.offset))}(n,o);var i=function(e,r,t){if(r.offsetReg){var n=!1;if(e=e.replace(r.offsetReg,(function(){return n=!0,""})),!n)throw new SyntaxError(T("Expected indent to be grater than 0 and less than "+(r.prevDepth+1)+", but got -1",t))}return e}(n,o,p);!function(e,r){if(!r.indentReg){var t=e.match(N)[2];t&&(r.indentReg=new RegExp(t,"g"))}}(i,o);var s=function(e,r,t){var n=0;r.indentReg&&(e=e.replace(/^\s*/,(function(e){return e.replace(r.indentReg,"\t")})));var a=e.replace(/^\t*/,(function(e){return n=e.length,""}));if(/^\s/.test(a))throw new SyntaxError(T("Bad indent",t));return{depth:n,content:a}}(i,o,p),c=s.depth,u=s.content;if(u){if(c<0||c-o.prevDepth>1||c-o.prevDepth==1&&-1===["comment","tag"].indexOf(o.prevType)||"comment"!==o.prevType&&0===c&&o.topExists)throw new SyntaxError(T("Expected indent to be grater than 0 and less than "+(o.prevDepth+1)+", but got "+c,p));var f=u[0];if(!(u=u.slice(1))&&">#%@.-+".indexOf(f)>=0)throw new SyntaxError(T("Empty content",p));switch((c<o.prevDepth||c===o.prevDepth&&"tag"===o.prevType)&&(o.currentNode=function(e,r){for(var t=e,n=0;n<r;n++)t=t[t.length-1];return t}(a,c)),o.prevDepth=c,f){case">":var l=function(e){var r={},t=w(e.replace(R,(function(e){return r.ref=e.slice(1),""})),"."),n=t[0],a=t.slice(1);return r.tag=m(n),r.class=O(a.join(".")),"string"==typeof r.class?r.class=D(r.class).trim():r.class[0]&&(r.class[0]=r.class[0].map(D)),r}(u),h=[{t:l.tag}];l.class&&(h[0].a={},h[0].a.class=l.class),l.ref&&(h[0].r=l.ref),o.currentNode.push(h),o.currentNode=h,o.prevType="tag";break;case"#":var g=function(e){var r=w(e,"=");return{name:m(r.shift().trim()),value:O(r.join("=").trim())}}(u),d=g.name,v=g.value;o.currentNode[0].a||(o.currentNode[0].a={}),o.currentNode[0].a[d]=v,o.prevType="attr";break;case"%":var y=function(e){var r=w(e,"="),t=r.shift().trim(),n=w(t,"@"),a=n[0],o=n[1],p=w(a,"!"),i=p[0],s=p[1],c=o&&U(o);return{propPath:w(i,".").map(m),value:O(r.join("=").trim()),updateOnly:s,syncTrigger:c}}(u),b=y.propPath,E=y.value,k=y.updateOnly,S=y.syncTrigger,$=[b,E];S?($.push(S),""===k&&$.push(1)):""===k&&$.push(0,1),o.currentNode[0].p||(o.currentNode[0].p=[]),o.currentNode[0].p.push($),o.prevType="prop";break;case"@":var I=function(e){var r=w(e,"=");return{name:r.shift().trim(),value:r.join("=").trim()}}(u),C=I.name,q=I.value;o.currentNode[0].e||(o.currentNode[0].e=[]);var P=U(C),_=function(e){var r=w(e,":"),t=r[0],n=r.slice(1).join(":"),a=m(t.trim());return n?[a,O(n)]:[a]}(q),A=_[0],F=_[1];P.m=A,F&&(P.v=F),o.currentNode[0].e.push(P),o.prevType="event";break;case".":(r=o.currentNode).push.apply(r,j(u)),o.prevType="text";break;case"|":o.currentNode.length>1&&(u="\n"+u),(t=o.currentNode).push.apply(t,j(u)),o.prevType="multiline-text";break;case"-":if(-1!==x.indexOf(u))throw new SyntaxError(T("Reserved name '"+u+"' should not be used",p));o.currentNode.push({n:u,t:0}),o.prevType="node";break;case"+":o.currentNode.push({n:u,t:1}),o.prevType="list";break;default:o.prevType="comment"}}}};return function(e){if(!e)throw new TypeError(T("Template required, but nothing given"));var r=typeof e;if("string"!==r)throw new TypeError(T("Expected a string, but got a(n) "+r));for(var t=e.split(/\r?\n/),n=[{t:0}],a={indentReg:null,prevDepth:0,offset:null,offsetReg:null,prevType:"comment",currentNode:n,topExists:!1},o=0;o<t.length;o++)q({line:t[o],ast:n,parsingInfo:a,i:o});if(n.length<=1)throw new SyntaxError(T("Nothing to be parsed",t.length-1));return 2===n.length&&Array.isArray(n[1])&&Object.hasOwnProperty.call(n[1][0],"t")?n[1]:n}}));
