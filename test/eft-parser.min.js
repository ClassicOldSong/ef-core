!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):(e=e||self).parseEft=r()}(this,function(){"use strict";function o(){throw new SyntaxError("Octal escape sequences are not allowed in EFML.")}function p(e){if(e=e.substr(3,e.length-4),!(e=parseInt(e,16)))throw new SyntaxError("Invalid Unicode escape sequence");try{return String.fromCodePoint(e)}catch(e){throw new SyntaxError("Undefined Unicode code-point")}}function i(e){if(e=e.substring(2),!(e=parseInt(e,16)))throw new SyntaxError("Invalid Unicode escape sequence");return String.fromCharCode(e)}function s(e){if(e="00"+e.substring(2),!(e=parseInt(e,16)))throw new SyntaxError("Invalid hexadecimal escape sequence");return String.fromCharCode(e)}function M(e){for(var r=[],t=0,n=e.split(g);t<n.length;t+=1){var a=n[t].replace(v,o).replace(m,p).replace(y,i).replace(w,s).replace(x,"\b").replace(E,"\t").replace(N,"\n").replace(R,"\v").replace(T,"\f").replace(k,"\r").replace(b,"");r.push(a)}return r.join(d)}function c(e,r){for(var t,n=[],a=!1,o=0,p=e.split(r);o<p.length;o+=1){var i=p[o];a?n[n.length-1]+=""+r+i:n.push(i),a=(t=i)[t.length-1]===d}return n}function B(e,r){for(var t=e.split(g),n=c(t.shift(),r),a=0,o=t;a<o.length;a+=1){var p=o[a],i=c(p,r);n[n.length-1]+=g+i.shift(),n.push.apply(n,i)}return n}function J(e,r){return void 0===r&&(r=-2),"Failed to parse eft template: "+e+". at line "+(r+1)}function u(e){return-1<["number","boolean","string"].indexOf(typeof e)}function f(r){if(!r)return[r,!1];try{var e=JSON.parse(r);return-1===["number","boolean"].indexOf(typeof e)?[M(r),!0]:[e,!1]}catch(e){return[M(r),!0]}}function a(e){e=e.slice(2,e.length-2);var r=B(e,"="),t=r[0],n=r.slice(1),a=B(t.trim(),".").map(M),o=f(n.join("=").trim()),p=o[0],i=o[1];return u(p)&&(i||!i&&""!==p)?[a,p]:[a]}function L(e){var r=e.split(S);if(1===r.length)return f(e)[0];var t=[];2!==r.length||r[0]||r[1]?t.push(r.map(M)):t.push(0);var n=e.match(S);return n&&t.push.apply(t,n.map(a)),t}function l(e,r){r&&e.push(r)}function z(e){var r=L(e);if(u(r))return[""+r];for(var t=r[0],n=r.slice(1),a=[],o=0;o<n.length;o++)l(a,t[o]),a.push(n[o]);return l(a,t[t.length-1]),a}function G(e){return e.replace(/\./g," ")}function H(e,r,t){var n=parseInt(t,10);if(isNaN(n))return function(e,r){switch(r){case"stop":e.s=1;break;case"stopImmediate":e.i=1;break;case"prevent":e.p=1;break;case"shift":e.h=1;break;case"alt":e.a=1;break;case"ctrl":e.c=1;break;case"meta":e.t=1;break;case"capture":e.u=1;break;default:console.warn("Abandoned unsupported eft event option '"+r+"'.")}}(e,M(t));r.push(n)}function h(e){var r,t,n=e.line,a=e.ast,o=e.parsingInfo,p=e.i;if(n.replace(/\s/,"")){var i,s;i=n,null===(s=o).offset&&(s.offset=i.match(/\s*/)[0],s.offset&&(s.offsetReg=s.offset));var c=function(e,r,t){if(r.offsetReg){var n=!1;if(e=e.replace(r.offsetReg,function(){return n=!0,""}),!n)throw new SyntaxError(J("Expected indent to be grater than 0 and less than "+(r.prevDepth+1)+", but got -1",t))}return e}(n,o,p);!function(e,r){if(!r.indentReg){var t=e.match(Q)[2];t&&(r.indentReg=new RegExp(t,"g"))}}(c,o);var u,f,l,h,d,g,v,m,y,w,b,x=function(e,r,t){var n=0;r.indentReg&&(e=e.replace(/^\s*/,function(e){return e.replace(r.indentReg,"\t")}));var a=e.replace(/^\t*/,function(e){return n=e.length,""});if(/^\s/.test(a))throw new SyntaxError(J("Bad indent",t));return{depth:n,content:a}}(c,o,p),E=x.depth,N=x.content;if(N){if(E<0||1<E-o.prevDepth||E-o.prevDepth==1&&-1===["comment","tag"].indexOf(o.prevType)||"comment"!==o.prevType&&0===E&&o.topExists)throw new SyntaxError(J("Expected indent to be grater than 0 and less than "+(o.prevDepth+1)+", but got "+E,p));var R=N[0];if(!(N=N.slice(1))&&0<=">#%@.-+".indexOf(R))throw new SyntaxError(J("Empty content",p));switch((E<o.prevDepth||E===o.prevDepth&&"tag"===o.prevType)&&(o.currentNode=function(e,r){for(var t=e,n=0;n<r;n++)t=t[t.length-1];return t}(a,E)),o.prevDepth=E,R){case">":var T=(m={},y=B(N.replace(V,function(e){return m.ref=e.slice(1),""}),"."),w=y[0],b=y.slice(1),m.tag=M(w),m.class=L(b.join(".")),"string"==typeof m.class?m.class=G(m.class).trim():m.class[0]&&(m.class[0]=m.class[0].map(G)),m),k=[{t:T.tag}];T.class&&(k[0].a={},k[0].a.class=T.class),T.ref&&(k[0].r=T.ref),o.currentNode.push(k),o.currentNode=k,o.prevType="tag";break;case"#":var S=(v=B(N,"="),{name:M(v.shift().trim()),value:L(v.join("=").trim())}),$=S.name,I=S.value;o.currentNode[0].a||(o.currentNode[0].a={}),o.currentNode[0].a[$]=I,o.prevType="attr";break;case"%":var O=(g=B(N,"="),{propPath:B(g.shift().trim(),".").map(M),value:L(g.join("=").trim())}),j=O.propPath,D=O.value;o.currentNode[0].p||(o.currentNode[0].p=[]),o.currentNode[0].p.push([j,D]),o.prevType="prop";break;case"@":var C={name:(d=B(N,"=")).shift().trim(),value:d.join("=").trim()},q=C.name,U=C.value;o.currentNode[0].e||(o.currentNode[0].e=[]);var P=function(e){var r={},t=[],n=B(e,"."),a=n[0],o=n.slice(1);r.l=M(a);for(var p=0,i=o;p<i.length;p+=1){var s=i[p];H(r,t,s)}return 0<t.length&&(r.k=t),r}(q),_=(u=B(U,":"),f=u[0],l=u.slice(1).join(":"),h=M(f.trim()),l?[h,L(l)]:[h]),A=_[0],F=_[1];P.m=A,F&&(P.v=F),o.currentNode[0].e.push(P),o.prevType="event";break;case".":(r=o.currentNode).push.apply(r,z(N)),o.prevType="text";break;case"|":1<o.currentNode.length&&(N="\n"+N),(t=o.currentNode).push.apply(t,z(N)),o.prevType="multiline-text";break;case"-":if(-1!==K.indexOf(N))throw new SyntaxError(J("Reserved name '"+N+"' should not be used",p));o.currentNode.push({n:N,t:0}),o.prevType="node";break;case"+":o.currentNode.push({n:N,t:1}),o.prevType="list";break;default:o.prevType="comment"}}}}var d="&",g=d+d,v=new RegExp("\\&[0-7]{1,3}","g"),m=new RegExp("\\&u\\[.*?\\]","g"),y=new RegExp("\\&u.{0,4}","g"),w=new RegExp("\\&x.{0,2}","g"),b=new RegExp("\\&","g"),x=new RegExp("\\&b","g"),E=new RegExp("\\&t","g"),N=new RegExp("\\&n","g"),R=new RegExp("\\&v","g"),T=new RegExp("\\&f","g"),k=new RegExp("\\&r","g"),K=["$ctx","$refs","$data","$methods","$mount","$umount","$subscribe","$unsubscribe","$update","$dispatch","$emit","$on","$off","$destroy","__DIRECTMOUNT__"],S=/\{\{.+?\}\}/g,Q=/^(\t*)( *).*/,V=/#([^}]|}[^}])*$/;return function(e){if(!e)throw new TypeError(J("Template required, but nothing given"));var r=typeof e;if("string"!=r)throw new TypeError(J("Expected a string, but got a(n) "+r));for(var t=e.split(/\r?\n/),n=[{t:0}],a={indentReg:null,prevDepth:0,offset:null,offsetReg:null,prevType:"comment",currentNode:n,topExists:!1},o=0;o<t.length;o++)h({line:t[o],ast:n,parsingInfo:a,i:o});if(n.length<=1)throw new SyntaxError(J("Nothing to be parsed",t.length-1));return 2===n.length&&Array.isArray(n[1])&&Object.hasOwnProperty.call(n[1][0],"t")?n[1]:n}});
