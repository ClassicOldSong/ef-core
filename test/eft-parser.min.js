!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):(e="undefined"!=typeof globalThis?globalThis:e||self).parseEft=r()}(this,(function(){"use strict";var e="&",r="&&",t=new RegExp("\\&[0-7]{1,3}","g"),n=new RegExp("\\&u\\[.*?\\]","g"),a=new RegExp("\\&u.{0,4}","g"),o=new RegExp("\\&x.{0,2}","g"),i=new RegExp("\\&","g"),p=new RegExp("\\&b","g"),s=new RegExp("\\&t","g"),c=new RegExp("\\&n","g"),u=new RegExp("\\&v","g"),f=new RegExp("\\&f","g"),l=new RegExp("\\&r","g"),h=function(){throw new SyntaxError("Octal escape sequences are not allowed in EFML.")},g=function(e){if(e=e.substr(3,e.length-4),!(e=parseInt(e,16)))throw new SyntaxError("Invalid Unicode escape sequence");try{return String.fromCodePoint(e)}catch(e){throw new SyntaxError("Undefined Unicode code-point")}},d=function(e){if(e=e.substring(2),!(e=parseInt(e,16)))throw new SyntaxError("Invalid Unicode escape sequence");return String.fromCharCode(e)},v=function(e){if(e="00"+e.substring(2),!(e=parseInt(e,16)))throw new SyntaxError("Invalid hexadecimal escape sequence");return String.fromCharCode(e)},m=function(m){for(var y=[],w=0,b=m.split(r);w<b.length;w+=1){var x=b[w].replace(t,h).replace(n,g).replace(a,d).replace(o,v).replace(p,"\b").replace(s,"\t").replace(c,"\n").replace(u,"\v").replace(f,"\f").replace(l,"\r").replace(i,"");y.push(x)}return y.join(e)},y=function(r){return r[r.length-1]===e},w=function(e,r){for(var t=[],n=!1,a=0,o=e.split(r);a<o.length;a+=1){var i=o[a];n?t[t.length-1]+=""+r+i:t.push(i),n=y(i)}return t},b=function(e,t){for(var n=e.split(r),a=w(n.shift(),t),o=0,i=n;o<i.length;o+=1){var p=i[o],s=w(p,t);a[a.length-1]+="&&"+s.shift(),a.push.apply(a,s)}return a},x=["$ctx","$refs","$data","$methods","$mount","$umount","$subscribe","$unsubscribe","$update","$dispatch","$emit","$on","$off","$destroy","__DIRECTMOUNT__"],E=/\{\{.+?\}\}/g,N=/^(\t*)( *).*/,R=/#([^}]|}[^}])*$/,T=function(e,r){return void 0===r&&(r=-2),"Failed to parse eft template: "+e+". at line "+(r+1)},k=function(e){return["number","boolean","string"].indexOf(typeof e)>-1},S=function(e){if(!e)return[e,!1];try{var r=JSON.parse(e);return-1===["number","boolean"].indexOf(typeof r)?[m(e),!0]:[r,!1]}catch(r){return[m(e),!0]}},$=function(e){e=e.slice(2,e.length-2);var r=b(e,"="),t=r[0],n=r.slice(1),a=b(t.trim(),".").map(m),o=S(n.join("=").trim()),i=o[0],p=o[1];return k(i)&&(p||!p&&""!==i)?[a,i]:[a]},I=function(e){var r=e.split(E);if(1===r.length)return S(e)[0];var t=[];2!==r.length||r[0]||r[1]?t.push(r.map(m)):t.push(0);var n=e.match(E);return n&&t.push.apply(t,n.map($)),t},D=function(e,r){r&&e.push(r)},O=function(e){var r=I(e);if(k(r))return[""+r];for(var t=r[0],n=r.slice(1),a=[],o=0;o<n.length;o++)D(a,t[o]),a.push(n[o]);return D(a,t[t.length-1]),a},j=function(e){return e.replace(/\./g," ")},C=function(e,r,t){var n=parseInt(t,10);if(isNaN(n))return function(e,r){switch(r){case"stop":e.s=1;break;case"stopImmediate":e.i=1;break;case"prevent":e.p=1;break;case"shift":e.h=1;break;case"alt":e.a=1;break;case"ctrl":e.c=1;break;case"meta":e.t=1;break;case"capture":e.u=1;break;default:console.warn("Dropped unsupported eft event option '"+r+"'.")}}(e,m(t));r.push(n)},q=function(e){var r={},t=[],n=b(e,"."),a=n[0],o=n.slice(1);r.l=m(a);for(var i=0,p=o;i<p.length;i+=1){var s=p[i];C(r,t,s)}return t.length>0&&(r.k=t),r},U=function(e){var r,t,n=e.line,a=e.ast,o=e.parsingInfo,i=e.i;if(n.replace(/\s/,"")){!function(e,r){null===r.offset&&(r.offset=e.match(/\s*/)[0],r.offset&&(r.offsetReg=r.offset))}(n,o);var p=function(e,r,t){if(r.offsetReg){var n=!1;if(e=e.replace(r.offsetReg,(function(){return n=!0,""})),!n)throw new SyntaxError(T("Expected indent to be grater than 0 and less than "+(r.prevDepth+1)+", but got -1",t))}return e}(n,o,i);!function(e,r){if(!r.indentReg){var t=e.match(N)[2];t&&(r.indentReg=new RegExp(t,"g"))}}(p,o);var s=function(e,r,t){var n=0;r.indentReg&&(e=e.replace(/^\s*/,(function(e){return e.replace(r.indentReg,"\t")})));var a=e.replace(/^\t*/,(function(e){return n=e.length,""}));if(/^\s/.test(a))throw new SyntaxError(T("Bad indent",t));return{depth:n,content:a}}(p,o,i),c=s.depth,u=s.content;if(u){if(c<0||c-o.prevDepth>1||c-o.prevDepth==1&&-1===["comment","tag"].indexOf(o.prevType)||"comment"!==o.prevType&&0===c&&o.topExists)throw new SyntaxError(T("Expected indent to be grater than 0 and less than "+(o.prevDepth+1)+", but got "+c,i));var f=u[0];if(!(u=u.slice(1))&&">#%@.-+".indexOf(f)>=0)throw new SyntaxError(T("Empty content",i));switch((c<o.prevDepth||c===o.prevDepth&&"tag"===o.prevType)&&(o.currentNode=function(e,r){for(var t=e,n=0;n<r;n++)t=t[t.length-1];return t}(a,c)),o.prevDepth=c,f){case">":var l=function(e){var r={},t=b(e.replace(R,(function(e){return r.ref=e.slice(1),""})),"."),n=t[0],a=t.slice(1);return r.tag=m(n),r.class=I(a.join(".")),"string"==typeof r.class?r.class=j(r.class).trim():r.class[0]&&(r.class[0]=r.class[0].map(j)),r}(u),h=[{t:l.tag}];l.class&&(h[0].a={},h[0].a.class=l.class),l.ref&&(h[0].r=l.ref),o.currentNode.push(h),o.currentNode=h,o.prevType="tag";break;case"#":var g=function(e){var r=b(e,"=");return{name:m(r.shift().trim()),value:I(r.join("=").trim())}}(u),d=g.name,v=g.value;o.currentNode[0].a||(o.currentNode[0].a={}),o.currentNode[0].a[d]=v,o.prevType="attr";break;case"%":var y=function(e){var r=b(e,"="),t=r.shift().trim(),n=b(t,"@"),a=n[0],o=n[1],i=o&&q(o);return{propPath:b(a,".").map(m),value:I(r.join("=").trim()),syncTrigger:i}}(u),w=y.propPath,E=y.value,k=y.syncTrigger,S=[w,E];k&&S.push(k),o.currentNode[0].p||(o.currentNode[0].p=[]),o.currentNode[0].p.push(S),o.prevType="prop";break;case"@":var $=function(e){var r=b(e,"=");return{name:r.shift().trim(),value:r.join("=").trim()}}(u),D=$.name,C=$.value;o.currentNode[0].e||(o.currentNode[0].e=[]);var U=q(D),P=function(e){var r=b(e,":"),t=r[0],n=r.slice(1).join(":"),a=m(t.trim());return n?[a,I(n)]:[a]}(C),_=P[0],A=P[1];U.m=_,A&&(U.v=A),o.currentNode[0].e.push(U),o.prevType="event";break;case".":(r=o.currentNode).push.apply(r,O(u)),o.prevType="text";break;case"|":o.currentNode.length>1&&(u="\n"+u),(t=o.currentNode).push.apply(t,O(u)),o.prevType="multiline-text";break;case"-":if(-1!==x.indexOf(u))throw new SyntaxError(T("Reserved name '"+u+"' should not be used",i));o.currentNode.push({n:u,t:0}),o.prevType="node";break;case"+":o.currentNode.push({n:u,t:1}),o.prevType="list";break;default:o.prevType="comment"}}}};return function(e){if(!e)throw new TypeError(T("Template required, but nothing given"));var r=typeof e;if("string"!==r)throw new TypeError(T("Expected a string, but got a(n) "+r));for(var t=e.split(/\r?\n/),n=[{t:0}],a={indentReg:null,prevDepth:0,offset:null,offsetReg:null,prevType:"comment",currentNode:n,topExists:!1},o=0;o<t.length;o++)U({line:t[o],ast:n,parsingInfo:a,i:o});if(n.length<=1)throw new SyntaxError(T("Nothing to be parsed",t.length-1));return 2===n.length&&Array.isArray(n[1])&&Object.hasOwnProperty.call(n[1][0],"t")?n[1]:n}}));
