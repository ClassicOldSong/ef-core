!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):(e=e||self).parseEft=r()}(this,function(){"use strict";function o(){throw new SyntaxError("Octal escape sequences are not allowed in EFML.")}function i(e){if(e=e.substr(3,e.length-4),!(e=parseInt(e,16)))throw new SyntaxError("Invalid Unicode escape sequence");try{return String.fromCodePoint(e)}catch(e){throw new SyntaxError("Undefined Unicode code-point")}}function p(e){if(e=e.substring(2),!(e=parseInt(e,16)))throw new SyntaxError("Invalid Unicode escape sequence");return String.fromCharCode(e)}function c(e){if(e="00"+e.substring(2),!(e=parseInt(e,16)))throw new SyntaxError("Invalid hexadecimal escape sequence");return String.fromCharCode(e)}function S(e){for(var r=[],t=0,n=e.split(d);t<n.length;t+=1){var a=n[t].replace(v,o).replace(m,i).replace(y,p).replace(w,c).replace(b,"\b").replace(E,"\t").replace(N,"\n").replace(R,"\v").replace(T,"\f").replace(k,"\r").replace(x,"");r.push(a)}return r.join(g)}function s(e,r){for(var t,n=[],a=!1,o=0,i=e.split(r);o<i.length;o+=1){var p=i[o];a?n[n.length-1]+=""+r+p:n.push(p),a=(t=p)[t.length-1]===g}return n}function I(e,r){for(var t=e.split(d),n=s(t.shift(),r),a=0,o=t;a<o.length;a+=1){var i=o[a],p=s(i,r);n[n.length-1]+=d+p.shift(),n.push.apply(n,p)}return n}function $(e,r){return void 0===r&&(r=-2),"Failed to parse eft template: "+e+". at line "+(r+1)}function u(e){return-1<["number","boolean","string"].indexOf(typeof e)}function f(r){if(!r)return[r,!1];try{var e=JSON.parse(r);return-1===["number","boolean"].indexOf(typeof e)?[S(r),!0]:[e,!1]}catch(e){return[S(r),!0]}}function a(e){e=e.slice(2,e.length-2);var r=I(e,"="),t=r[0],n=r.slice(1),a=I(t.trim(),".").map(S),o=f(n.join("=").trim()),i=o[0],p=o[1];return u(i)&&(p||!p&&""!==i)?[a,i]:[a]}function D(e){var r=e.split(_);if(1===r.length)return f(e)[0];var t=[];2!==r.length||r[0]||r[1]?t.push(r.map(S)):t.push(0);var n=e.match(_);return n&&t.push.apply(t,n.map(a)),t}function l(e,r){r&&e.push(r)}function O(e){var r=D(e);if(u(r))return[""+r];for(var t=r[0],n=r.slice(1),a=[],o=0;o<n.length;o++)l(a,t[o]),a.push(n[o]);return l(a,t[t.length-1]),a}function j(e){return e.replace(/\./g," ")}function C(e){var r=I(e,"=");return{name:S(r.shift().trim()),value:D(r.join("=").trim())}}function q(e,r,t){var n=parseInt(t,10);if(isNaN(n))return function(e,r){switch(r){case"stop":e.s=1;break;case"stopImmediate":e.i=1;break;case"prevent":e.p=1;break;case"shift":e.h=1;break;case"alt":e.a=1;break;case"ctrl":e.c=1;break;case"meta":e.t=1;break;case"capture":e.u=1;break;default:console.warn("Abandoned unsupported eft event option '"+r+"'.")}}(e,S(t));r.push(n)}function h(e){var r,t,n=e.line,a=e.ast,o=e.parsingInfo,i=e.i;if(!function(e){return!e.replace(/\s/,"")}(n)){!function(e,r){null===r.offset&&(r.offset=e.match(/\s*/)[0],r.offset&&(r.offsetReg=r.offset))}(n,o);var p=function(e,r,t){if(r.offsetReg){var n=!1;if(e=e.replace(r.offsetReg,function(){return n=!0,""}),!n)throw new SyntaxError($("Expected indent to be grater than 0 and less than "+(r.prevDepth+1)+", but got -1",t))}return e}(n,o,i);!function(e,r){if(!r.indentReg){var t=e.match(A)[2];t&&(r.indentReg=new RegExp(t,"g"))}}(p,o);var c=function(e,r,t){var n=0;r.indentReg&&(e=e.replace(/^\s*/,function(e){return e.replace(r.indentReg,"\t")}));var a=e.replace(/^\t*/,function(e){return n=e.length,""});if(/^\s/.test(a))throw new SyntaxError($("Bad indent",t));return{depth:n,content:a}}(p,o,i),s=c.depth,u=c.content;if(u){if(s<0||1<s-o.prevDepth||s-o.prevDepth==1&&-1===["comment","tag"].indexOf(o.prevType)||"comment"!==o.prevType&&0===s&&o.topExists)throw new SyntaxError($("Expected indent to be grater than 0 and less than "+(o.prevDepth+1)+", but got "+s,i));var f=u[0];if(!(u=u.slice(1))&&0<=">#%@.-+".indexOf(f))throw new SyntaxError($("Empty content",i));switch((s<o.prevDepth||s===o.prevDepth&&"tag"===o.prevType)&&(o.currentNode=function(e,r){for(var t=e,n=0;n<r;n++)t=t[t.length-1];return t}(a,s)),o.prevDepth=s,f){case">":var l=function(e){var r={},t=I(e.replace(F,function(e){return r.ref=e.slice(1),""}),"."),n=t[0],a=t.slice(1);return r.tag=S(n),r.class=D(a.join(".")),"string"==typeof r.class?r.class=j(r.class).trim():r.class[0]&&(r.class[0]=r.class[0].map(j)),r}(u),h=[{t:l.tag}];l.class&&(h[0].a={},h[0].a.class=l.class),l.ref&&(h[0].r=l.ref),o.currentNode.push(h),o.currentNode=h,o.prevType="tag";break;case"#":var g=C(u),d=g.name,v=g.value;o.currentNode[0].a||(o.currentNode[0].a={}),o.currentNode[0].a[d]=v,o.prevType="attr";break;case"%":var m=C(u),y=m.name,w=m.value;o.currentNode[0].p||(o.currentNode[0].p={}),o.currentNode[0].p[y]=w,o.prevType="prop";break;case"@":var x=function(e){var r=I(e,"=");return{name:r.shift().trim(),value:r.join("=").trim()}}(u),b=x.name,E=x.value;o.currentNode[0].e||(o.currentNode[0].e=[]);var N=function(e){var r={},t=[],n=I(e,"."),a=n[0],o=n.slice(1);r.l=S(a);for(var i=0,p=o;i<p.length;i+=1){var c=p[i];q(r,t,c)}return 0<t.length&&(r.k=t),r}(b),R=function(e){var r=I(e,":"),t=r[0],n=r.slice(1).join(":"),a=S(t.trim());return n?[a,D(n)]:[a]}(E),T=R[0],k=R[1];N.m=T,k&&(N.v=k),o.currentNode[0].e.push(N),o.prevType="event";break;case".":(r=o.currentNode).push.apply(r,O(u)),o.prevType="text";break;case"|":1<o.currentNode.length&&(u="\n"+u),(t=o.currentNode).push.apply(t,O(u)),o.prevType="multiline-text";break;case"-":if(-1!==U.indexOf(u))throw new SyntaxError($("Reserved name '"+u+"' should not be used",i));o.currentNode.push({n:u,t:0}),o.prevType="node";break;case"+":o.currentNode.push({n:u,t:1}),o.prevType="list";break;default:o.prevType="comment"}}}}var g="&",d=g+g,v=new RegExp("\\&[0-7]{1,3}","g"),m=new RegExp("\\&u\\[.*?\\]","g"),y=new RegExp("\\&u.{0,4}","g"),w=new RegExp("\\&x.{0,2}","g"),x=new RegExp("\\&","g"),b=new RegExp("\\&b","g"),E=new RegExp("\\&t","g"),N=new RegExp("\\&n","g"),R=new RegExp("\\&v","g"),T=new RegExp("\\&f","g"),k=new RegExp("\\&r","g"),U=["$ctx","$data","$refs","$methods","$mount","$umount","$subscribe","$unsubscribe","$update","$destroy","__DIRECTMOUNT__"],_=/\{\{.+?\}\}/g,A=/^(\t*)( *).*/,F=/#([^}]|}[^}])*$/;return function(e){if(!e)throw new TypeError($("Template required, but nothing given"));var r=typeof e;if("string"!=r)throw new TypeError($("Expected a string, but got a(n) "+r));for(var t=e.split(/\r?\n/),n=[{t:0}],a={indentReg:null,prevDepth:0,offset:null,offsetReg:null,prevType:"comment",currentNode:n,topExists:!1},o=0;o<t.length;o++)h({line:t[o],ast:n,parsingInfo:a,i:o});if(n.length<=1)throw new SyntaxError($("Nothing to be parsed",t.length-1));return 2!==n.length||Array.isArray(n[1][0])?n:n[1]}});
